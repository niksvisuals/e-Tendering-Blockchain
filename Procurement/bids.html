<!-- only this file uses web3js v1.9.0 documentation link 	https://web3js.readthedocs.io/en/v1.9.0/ -->

<html>

<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Bids - G.o.I</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
		integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
	<link href="https://fonts.googleapis.com/css?family=Noto+Sans&display=swap" rel="stylesheet">
	<link href="styles/css/app.css" rel="stylesheet">
	<!-- <script src="scripts/web3.js/web3.min.js"></script> -->
	<script src="scripts/web3_1.9/web3.min.js"></script>
	<script src="scripts/custom/shortListBids.js"></script>
	<script type="text/javascript">
		var fcontract_address = '0xd481543BBD94cC8b668BB8ef46DEE01F4ac310CE'

		var fcontract_abi = [
			{
				"constant": false,
				"inputs": [
					{
						"name": "_address",
						"type": "address"
					}
				],
				"name": "addVoteManager",
				"outputs": [],
				"payable": false,
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"constant": false,
				"inputs": [
					{
						"name": "description",
						"type": "string"
					}
				],
				"name": "createTender",
				"outputs": [],
				"payable": false,
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [],
				"payable": false,
				"stateMutability": "nonpayable",
				"type": "constructor"
			},
			{
				"constant": true,
				"inputs": [],
				"name": "getDeployedTenders",
				"outputs": [
					{
						"name": "",
						"type": "address[]"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			}
		]
		// contract Tender abi
		var contract_abi = [
			{
				"constant": true,
				"inputs": [],
				"name": "verifyManager",
				"outputs": [
					{
						"name": "",
						"type": "bool"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [],
				"name": "status",
				"outputs": [
					{
						"name": "",
						"type": "bool"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": false,
				"inputs": [
					{
						"name": "_preferences",
						"type": "uint256[]"
					}
				],
				"name": "castVote",
				"outputs": [],
				"payable": false,
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [],
				"name": "getBidCount",
				"outputs": [
					{
						"name": "",
						"type": "uint256"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": false,
				"inputs": [
					{
						"name": "bidAmount",
						"type": "uint256"
					},
					{
						"name": "desc",
						"type": "string"
					}
				],
				"name": "makeBid",
				"outputs": [],
				"payable": false,
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [
					{
						"name": "",
						"type": "uint256"
					}
				],
				"name": "bids",
				"outputs": [
					{
						"name": "bidder",
						"type": "address"
					},
					{
						"name": "bidAmount",
						"type": "uint256"
					},
					{
						"name": "bid",
						"type": "string"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [],
				"name": "data",
				"outputs": [
					{
						"name": "",
						"type": "string"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [],
				"name": "voterLength",
				"outputs": [
					{
						"name": "",
						"type": "uint256"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": false,
				"inputs": [
					{
						"name": "index",
						"type": "uint256"
					}
				],
				"name": "setWinnerBid",
				"outputs": [],
				"payable": false,
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"constant": false,
				"inputs": [
					{
						"components": [
							{
								"name": "bidder",
								"type": "address"
							},
							{
								"name": "bidAmount",
								"type": "uint256"
							},
							{
								"name": "bid",
								"type": "string"
							}
						],
						"name": "_bids",
						"type": "tuple[]"
					}
				],
				"name": "setShortlistedBids",
				"outputs": [],
				"payable": false,
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [],
				"name": "getShortlistedBidsCount",
				"outputs": [
					{
						"name": "",
						"type": "uint256"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [
					{
						"name": "",
						"type": "uint256"
					}
				],
				"name": "shortlistedBids",
				"outputs": [
					{
						"name": "bidder",
						"type": "address"
					},
					{
						"name": "bidAmount",
						"type": "uint256"
					},
					{
						"name": "bid",
						"type": "string"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [
					{
						"name": "",
						"type": "address"
					}
				],
				"name": "voters",
				"outputs": [
					{
						"name": "voted",
						"type": "bool"
					},
					{
						"name": "isRegistered",
						"type": "bool"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [
					{
						"name": "voter",
						"type": "address"
					}
				],
				"name": "getPreferencesList",
				"outputs": [
					{
						"name": "",
						"type": "uint256[]"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [],
				"name": "areBidsShortListed",
				"outputs": [
					{
						"name": "",
						"type": "bool"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [],
				"name": "winner",
				"outputs": [
					{
						"name": "bidder",
						"type": "address"
					},
					{
						"name": "bidAmount",
						"type": "uint256"
					},
					{
						"name": "bid",
						"type": "string"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [],
				"name": "getTenderSummary",
				"outputs": [
					{
						"name": "",
						"type": "address"
					},
					{
						"name": "",
						"type": "string"
					},
					{
						"name": "",
						"type": "uint256"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [
					{
						"name": "index",
						"type": "uint256"
					}
				],
				"name": "getSingleBid",
				"outputs": [
					{
						"name": "",
						"type": "address"
					},
					{
						"name": "",
						"type": "uint256"
					},
					{
						"name": "",
						"type": "string"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [
					{
						"name": "",
						"type": "uint256"
					}
				],
				"name": "voteManager",
				"outputs": [
					{
						"name": "",
						"type": "address"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"name": "description",
						"type": "string"
					},
					{
						"name": "creator",
						"type": "address"
					},
					{
						"name": "_voteManager",
						"type": "address[]"
					}
				],
				"payable": false,
				"stateMutability": "nonpayable",
				"type": "constructor"
			}
		]

		window.ethereum.enable()

		if (typeof web3 !== "undefined") {
			web3 = new Web3(web3.currentProvider);
		} else {
			// set the provider you want from Web3.providers
			console.log("not detected");
			web3 = new Web3(
				new Web3.providers.HttpProvider("http://localhost:7545")
			);
		}

		var fcontract_instance;
		fcontract_instance = new web3.eth
			.Contract(fcontract_abi, fcontract_address);

	</script>
	<style>
		.finalize {
			width: 300px;
			margin: auto;
		}
	</style>
</head>

<body>
	<div class="home">
		<div class="topbar">
			BIDS
		</div>
		<table class="table table-striped">
			<thead>
				<tr>
					<th scope="col">Bidder Address</th>
					<th scope="col">Biding Amount</th>
					<th scope="col">Bid Description</th>
				</tr>
			</thead>
			<tbody id="bidss">
			</tbody>
		</table>
		<div class="content">
			<div class="finalize">
				<!-- <input id="finalIndex" type="text" class="form-control" placeholder="Enter Bidder Address"
					aria-label="Username" aria-describedby="basic-addon1" /> -->
				<button type="button" onclick="shotListBidsBySorting(bids, contract_instance)"
					class="btn btn-primary">Shortlist Bids</button>
			</div>
			<button style="display:none" type="button" onclick="addAddr()" data-toggle="modal" data-target="#bidModal"
				class="btn btn-primary" id="myCheck">Finalize</button>
			<div class="modal show" id="bidModal" tabindex="-1" role="dialog" aria-labelledby="bidModalLabel"
				aria-hidden="true">
				<div class="modal-dialog" role="document">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title" id="exampleModalLabel">ENTER TENDER ADDRESS</h5>
							<button type="button" class="close" data-dismiss="modal" aria-label="Close">
								<span aria-hidden="true">&times;</span>
							</button>
						</div>
						<div class="modal-body">
							<div class="input-group mb-3">
								<input id="address" type="text" class="form-control" placeholder="Address"
									aria-label="Username" aria-describedby="basic-addon1" /><br />
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-primary" data-dismiss="modal"
								onclick="setAddr()">Submit</button>
						</div>
					</div>
				</div>
			</div>
			<div class="modal fade" id="tenderModal" tabindex="-1" role="dialog" aria-labelledby="tenderModalLabel"
				aria-hidden="true">
				<div class="modal-dialog" role="document">
					<div class="modal-content">
						<div id="tender-content">
							<div class="modal-header">
								<h5 class="modal-title" id="exampleModalLabel">INPUTS</h5>
								<button type="button" class="close" data-dismiss="modal" aria-label="Close">
									<span aria-hidden="true">&times;</span>
								</button>
							</div>
							<div class="modal-body">
								<div class="input-group mb-3">
									<input id="inputsItemid" type="text" class="form-control" placeholder="Item ID"
										aria-label="Item ID" aria-describedby="basic-addon1" />
								</div>
								<div class="input-group mb-3">
									<input disabled id="inputBidaddr" type="text" class="form-control"
										placeholder="Vendor Address" aria-label="Username"
										aria-describedby="basic-addon1" value="" />
								</div>
								<div class="input-group mb-3">
									<input id="inputEmailAddress" type="email" class="form-control" placeholder="Email"
										aria-label="Username" aria-describedby="basic-addon1" />
								</div>
								<div class="input-group mb-3">
									<input disabled id="inputAmt" type="text" class="form-control"
										placeholder="Quotation" aria-label="Username" aria-describedby="basic-addon1" />
								</div>
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-secondary" data-dismiss="modal">
									Close
								</button>
								<button type="button" class="btn btn-primary submit" id="submit-allot"
									onclick="finalizeBid()">
									Submit
								</button>
							</div>
						</div>
						<!-- <div id="loading">
		  <img src="/load.gif" id="img" style="display:none" />
		</div>
		<div id="success">
		  <p style="display:none;">Block Mined successfully!!!!!</p>
		</div> -->
					</div>
				</div>
			</div>
		</div>
</body>
<script src="https://kit.fontawesome.com/148a1c7248.js" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
	integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
	crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
	integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
	crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
	integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
	crossorigin="anonymous"></script>
<!-- <script src="scripts/custom/bids.js"></script> -->
<script src="scripts/jquery/jquery.min.js"></script>
<script>
	var index;
	// var contract_address = "0xA6D75D3d81DE1d582B0b707Ae887E6b41082d709";
	document.getElementById("myCheck").click();
	var contract_address = "0xA6D75D3d81DE1d582B0b707Ae887E6b41082d709";
	let bids = [];
	let contract_instance;
	var l;
	let accounts = []
	web3.eth.getAccounts().then(res => accounts = res)
	function setAddr() {
		contract_address = document.getElementById("address").value;
		// console.log(contract_address);
		contract_instance = new web3.eth
			.Contract(contract_abi, contract_address);
		contract_instance.methods.getBidCount().call().then(res => {
			l = res;
			// console.log('no of bids set from blockchain l -> ', l)
			getBids();
			setTimeout(function () {
				populateBids();
			}, 500);
		}).catch(err => { console.log(sd); console.log(error); })
		/* contract_instance.methods.getBidCount().call({ from: accounts[0] }, function (error, result) {
			if (error) {
				console.log("sd");
				console.log(error);
			}
			else {
				// console.log(result, 'result bid count')
				// console.log(result.c[0]);
				l = result.c[0];
				getBids();
			}
			setTimeout(function () {
				populateBids();
			}, 500);
		}) */
	}
	function addAddr() {
		console.log("sdffgg")
	}

	var increment = 0;
	function getBids() {
		for (var i = 0; i < l; i++) {
			let bid;
			contract_instance.methods.getSingleBid(i).call({ from: accounts[0] }, function (error, result) {
				if (error) {
					console.log("sd");
					console.log(error.data.message);
				}
				else {
					// console.log(result, "dff");
					//result 0 is bidders address,
					// console.log(result)
					let bid = { index: result[0], amt: result[1], descp: result[2], id: increment++ };
					bids.push(bid);
				}
			})
		}
		populateBids();
	}
	function indexClicked(value) {
		index = value;
		var copyText = document.getElementById(value);
		let obj = bids.find(o => o.index == value);
		let amt = obj.amt.toString();
		// console.log(copyText);
		// console.log(obj)
		copyText.select();
		copyText.setSelectionRange(0, 99999);
		document.execCommand("copy");
		document.getElementById('inputBidaddr').value = value;
		document.getElementById('inputAmt').value = amt;
		// console.log(value, index);

		// var finalIndex = document.getElementById("finalIndex");
		// finalIndex.value = value;
	}
	function populateBids() {
		// console.log("populate", bids);
		var bidsBody = document.getElementById("bidss");
		bids.forEach(e => {
			// console.log(e);
			bidsBody.innerHTML += "<tr data-toggle='modal' data-target='#tenderModal' ><td><input id='" + e.index + "' onclick='indexClicked(this.id)' style='background-color:transparent;border;none' value='" + e.index + "'/></td><td>" + e.amt.toString() + "</td><td>" + e.descp + "</td><td></td></tr>";
		});
	}

</script>

<script src="scripts/jquery/jquery.min.js"></script>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
	integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
	crossorigin="anonymous"></script>

</html>