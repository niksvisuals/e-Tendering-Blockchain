<html>

<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Admin - G.o.I</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
		integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous" />
	<link href="https://fonts.googleapis.com/css?family=Noto+Sans&display=swap" rel="stylesheet" />
	<link href="styles/css/app.css" rel="stylesheet" />
	<script src="scripts/web3.js/web3.min.js"></script>
	<script src="scripts/custom/qrcode.js"></script>

	<script type="text/javascript">
		var fcontract_address = '0xd481543BBD94cC8b668BB8ef46DEE01F4ac310CE'

		var fcontract_abi = [
			{
				"constant": false,
				"inputs": [
					{
						"name": "_address",
						"type": "address"
					}
				],
				"name": "addVoteManager",
				"outputs": [],
				"payable": false,
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"constant": false,
				"inputs": [
					{
						"name": "description",
						"type": "string"
					}
				],
				"name": "createTender",
				"outputs": [],
				"payable": false,
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [],
				"payable": false,
				"stateMutability": "nonpayable",
				"type": "constructor"
			},
			{
				"constant": true,
				"inputs": [],
				"name": "getDeployedTenders",
				"outputs": [
					{
						"name": "",
						"type": "address[]"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			}
		]
		// contract Tender abi
		var contract_abi = [
			{
				"constant": true,
				"inputs": [],
				"name": "verifyManager",
				"outputs": [
					{
						"name": "",
						"type": "bool"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [],
				"name": "status",
				"outputs": [
					{
						"name": "",
						"type": "bool"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": false,
				"inputs": [
					{
						"name": "_preferences",
						"type": "uint256[]"
					}
				],
				"name": "castVote",
				"outputs": [],
				"payable": false,
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [],
				"name": "getBidCount",
				"outputs": [
					{
						"name": "",
						"type": "uint256"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": false,
				"inputs": [
					{
						"name": "bidAmount",
						"type": "uint256"
					},
					{
						"name": "desc",
						"type": "string"
					}
				],
				"name": "makeBid",
				"outputs": [],
				"payable": false,
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [
					{
						"name": "",
						"type": "uint256"
					}
				],
				"name": "bids",
				"outputs": [
					{
						"name": "bidder",
						"type": "address"
					},
					{
						"name": "bidAmount",
						"type": "uint256"
					},
					{
						"name": "bid",
						"type": "string"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [],
				"name": "data",
				"outputs": [
					{
						"name": "",
						"type": "string"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [],
				"name": "voterLength",
				"outputs": [
					{
						"name": "",
						"type": "uint256"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": false,
				"inputs": [
					{
						"name": "index",
						"type": "uint256"
					}
				],
				"name": "setWinnerBid",
				"outputs": [],
				"payable": false,
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"constant": false,
				"inputs": [
					{
						"components": [
							{
								"name": "bidder",
								"type": "address"
							},
							{
								"name": "bidAmount",
								"type": "uint256"
							},
							{
								"name": "bid",
								"type": "string"
							}
						],
						"name": "_bids",
						"type": "tuple[]"
					}
				],
				"name": "setShortlistedBids",
				"outputs": [],
				"payable": false,
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [],
				"name": "getShortlistedBidsCount",
				"outputs": [
					{
						"name": "",
						"type": "uint256"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [
					{
						"name": "",
						"type": "uint256"
					}
				],
				"name": "shortlistedBids",
				"outputs": [
					{
						"name": "bidder",
						"type": "address"
					},
					{
						"name": "bidAmount",
						"type": "uint256"
					},
					{
						"name": "bid",
						"type": "string"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [
					{
						"name": "",
						"type": "address"
					}
				],
				"name": "voters",
				"outputs": [
					{
						"name": "voted",
						"type": "bool"
					},
					{
						"name": "isRegistered",
						"type": "bool"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [
					{
						"name": "voter",
						"type": "address"
					}
				],
				"name": "getPreferencesList",
				"outputs": [
					{
						"name": "",
						"type": "uint256[]"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [],
				"name": "areBidsShortListed",
				"outputs": [
					{
						"name": "",
						"type": "bool"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [],
				"name": "winner",
				"outputs": [
					{
						"name": "bidder",
						"type": "address"
					},
					{
						"name": "bidAmount",
						"type": "uint256"
					},
					{
						"name": "bid",
						"type": "string"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [],
				"name": "getTenderSummary",
				"outputs": [
					{
						"name": "",
						"type": "address"
					},
					{
						"name": "",
						"type": "string"
					},
					{
						"name": "",
						"type": "uint256"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [
					{
						"name": "index",
						"type": "uint256"
					}
				],
				"name": "getSingleBid",
				"outputs": [
					{
						"name": "",
						"type": "address"
					},
					{
						"name": "",
						"type": "uint256"
					},
					{
						"name": "",
						"type": "string"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [
					{
						"name": "",
						"type": "uint256"
					}
				],
				"name": "voteManager",
				"outputs": [
					{
						"name": "",
						"type": "address"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"name": "description",
						"type": "string"
					},
					{
						"name": "creator",
						"type": "address"
					},
					{
						"name": "_voteManager",
						"type": "address[]"
					}
				],
				"payable": false,
				"stateMutability": "nonpayable",
				"type": "constructor"
			}
		]

		window.ethereum.enable()
		if (typeof web3 !== "undefined") {
			web3 = new Web3(web3.currentProvider);
		} else {
			// set the provider you want from Web3.providers
			console.log("not detected");
			web3 = new Web3(
				new Web3.providers.HttpProvider("http://localhost:7545")
			);
		}

		var fcontract_instance;
		fcontract_instance = web3.eth
			.contract(fcontract_abi)
			.at(fcontract_address);
      // console.log(fcontract_instance.createTender('tender 2'))
	</script>
</head>

<body>
	<div class="home">
		<div class="topbar">
			Admin
		</div>
		<div class="content">
			<div class="btn-wrapper">
				<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#tenderModal">
					CREATE TENDER
				</button>
			</div>
			<div class="btn-wrapper">
				<button id="bids" type="button" class="btn btn-primary">
					SEE BIDS MADE
				</button>
			</div>
			<div class="btn-wrapper">
				<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#adminModal">
					ADD MANAGER
				</button>
			</div>
			<div class="btn-wrapper">
				<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#findWinnerModal">
					DECLARE RESULT for TENDER
				</button>
			</div>
		</div>
		<div class="modal fade" id="tenderModal" tabindex="-1" role="dialog" aria-labelledby="tenderModalLabel"
			aria-hidden="true">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="exampleModalLabel">CREATE TENDER</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<div class="input-group mb-3">
							<textarea id="descp" type="text" class="form-control" placeholder="Description"
								aria-label="Item ID" aria-describedby="basic-addon1"></textarea>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-dismiss="modal">
							Close
						</button>
						<button type="button" class="btn btn-primary" onclick="createTender()" data-dismiss="modal">
							Submit
						</button>
					</div>
				</div>
			</div>
		</div>
		<div class="modal fade" id="adminModal" tabindex="-1" role="dialog" aria-labelledby="adminModalLabel"
			aria-hidden="true">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="modalLabel">ADD NEW MANAGER FOR VOTING</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<div class="input-group mb-3">
							<input id="adminLabel" type="text" class="form-control" placeholder="Address" aria-label=""
								aria-describedby="basic-addon1"></input>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-dismiss="modal">
							Close
						</button>
						<button type="button" class="btn btn-primary" onclick="addAdminHandler()" data-dismiss="modal">
							Submit
						</button>
					</div>
				</div>
			</div>
		</div>
		<div class="modal fade" id="findWinnerModal" tabindex="-1" role="dialog" aria-hidden="true">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="winner">Tender Address</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<div class="input-group mb-3">
							<input id="winnerLabel" type="text" class="form-control" placeholder="Address"
								aria-label=""></input>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-dismiss="modal">
							Close
						</button>
						<button type="button" class="btn btn-primary" onclick="findWinnerHandler()"
							data-dismiss="modal">
							Find Winner
						</button>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>
<script>
	// calculate winner for particular tender

	function findWinnerHandler() {
		const tenderAddr = document.getElementById("winnerLabel").value;
		// console.log(web3.isAddress(tenderAddr))
		// console.log(tenderAddr)
		const contract_instance = web3.eth
			.contract(contract_abi)
			.at(tenderAddr);
		let callback = 0
		let voters = []
		try {
			for (let i = 0; i < 3; i++) {
				contract_instance.voteManager(i, (err, res) => {

					if (err) {
						console.log('error while getting voter address')
						console.log(err)
					} else {
						// console.log('voter address', res)
						voters.push(res)
						callback++
						if (callback == 3) {
							getVotes(voters, contract_instance)
						}
					}
				})
			}
		} catch (e) {
			console.log(e)
			console.log('error while calculating winner')
		}

	}

	function getVotes(voters, contract_instance) {
		let votesByVoters = []
		let callback = 0
		// console.log(contract_instance, 'line 627')
		voters.forEach(voter => {
			contract_instance.getPreferencesList.call(voter, (err, res) => {
				if (err) {
					console.log(voter, err.data.message);
				} else {
					contract_instance.getPreferencesList(voter, (err, result) => {
						if (err) {
							console.log(err.data.message)
						} else {
							// result from blockchain is not formatted correctly
							let arr = result.map(res => res.c[0])
							votesByVoters.push(arr)
							callback++
							if (callback == 3) {
								callingSTV(votesByVoters, contract_instance)
							}
							// console.log(arr, 'local res')
						}
					})
				}
			})
		})
		// console.log('votes by voters', votesByVoters)
	}
	function callingSTV(votesArray, contract_instance) {
		//TODO change the candidates array that is hardcoded, second parameter
		let resultIndex = runSTV(1, [0, 1], votesArray)
		contract_instance.shortlistedBids(resultIndex, { from: web3.eth.accounts[0] }, (err, res) => {
			if (err) { console.log(err, 'error occured while getting the winner bid') }
			else {
				// console.log('winner bid ondex from shortlisted bids line 648', res)
				contract_instance.setWinnerBid(resultIndex, { from: web3.eth.accounts[0] }, (err, result) => {
					if (err) {
						console.log(err, 'error occured while getting the winner bid')
					} else {
						callWhenMined(result)
						console.log('Winner Bid set successful')
						console.log('%cWinner is index ' + resultIndex, 'color:green; font-size:48px')
					}
				})
			}
		})
	}

	function addAdminHandler() {
		var adminAddr = document.getElementById("adminLabel").value;
		fcontract_instance.addVoteManager.call(adminAddr, { from: web3.eth.accounts[0] }, function (error, result) {
			if (error) {
				console.log(error.data.message);
			} else {
				fcontract_instance.addVoteManager.sendTransaction(adminAddr, { from: web3.eth.accounts[0] }, function (error, result) {
					if (error) {
						console.log(error.data.message)
					} else {
						callWhenMined(result, mined);
					}
				})
			}
		})
		document.getElementById("adminLabel").value = "";
	}

	function createTender() {
		var descp = document.getElementById("descp").value;
		// console.log(descp);
		// console.log(web3.eth.accounts, 'eth accounts')
		fcontract_instance.createTender(
			descp,
			{ from: web3.eth.accounts[0] },
			function (error, result) {
				if (error) {
					console.log(error.data.message);
				} else {
					var txHash = result;
					console.log(txHash, 'transaction hash');
					callWhenMined(txHash, mined);
				}
			}
		);
		document.getElementById("descp").value = "";
	}

	function mined() {
		console.log("Transaction Mined");
	}
	function callWhenMined(txHash, callback) {
		web3.eth.getTransactionReceipt(txHash, function (error, rcpt) {
			if (error) {
				console.log(error.data.message);
			} else {
				if (rcpt == null) {
					console.log('failed to retrieve trx receipt')
					/* setTimeout(function () {
						callWhenMined(txHash, callback);
					}, 500); */
				} else {
					if (rcpt.status === '0x0') {
						console.log('tx failed')
					} else {

						// console.log(rcpt, 'tx receipt')	
						callback();
					}
				}
			}
		});
	}
</script>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
	integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
	crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
	integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
	crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
	integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
	crossorigin="anonymous"></script>
<script src="scripts/custom/index.js"></script>
<script src="scripts/jquery/jquery.min.js"></script>
<script src="scripts/custom/stv.js"></script>

</html>